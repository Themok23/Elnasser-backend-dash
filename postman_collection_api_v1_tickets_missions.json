{
  "info": {
    "name": "Elnasser Backend API V1 - Tickets & Missions",
    "description": "Complete ticket lifecycle testing collection with auto-saved variables (auth_token, ticket_id, ticket_number).",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_postman_id": "tickets-missions-v1"
  },
  "variable": [
    { "key": "base_url", "value": "http://127.0.0.1:8000", "type": "string" },
    { "key": "auth_token", "value": "", "type": "string" },
    { "key": "ticket_id", "value": "", "type": "string" },
    { "key": "ticket_number", "value": "", "type": "string" },
    { "key": "mission_id", "value": "1", "type": "string" }
  ],
  "item": [
    {
      "name": "Tickets - Complete Lifecycle",
      "item": [
        {
          "name": "1. Login (Customer) - Auto-saves auth_token",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var json = {};",
                  "try { json = pm.response.json(); } catch (e) {}",
                  "var token = json.token || json.access_token || (json.data && json.data.token);",
                  "if (token) {",
                  "  pm.collectionVariables.set('auth_token', token);",
                  "  pm.environment.set('auth_token', token);",
                  "  console.log('Token saved:', token);",
                  "}",
                  "pm.test('Token saved to auth_token', function () {",
                  "  pm.expect(pm.collectionVariables.get('auth_token') || pm.environment.get('auth_token')).to.not.be.empty;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" },
              { "key": "Content-Type", "value": "application/json", "type": "text" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"login_type\": \"manual\",\n  \"email_or_phone\": \"01234567890\",\n  \"password\": \"123456\",\n  \"field_type\": \"phone\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/login",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "login"]
            },
            "description": "**Step 1:** Login to get authentication token.\n\nReplace `email_or_phone` and `password` with valid user credentials.\n\nToken is automatically saved to `auth_token` variable."
          },
          "response": []
        },
        {
          "name": "2. Get Parent Types",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/types/parents",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "types", "parents"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 2:** Get all parent ticket types.\n\nUse the `id` from response to create a ticket or get children."
          },
          "response": []
        },
        {
          "name": "2b. Get Children by Parent ID",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/types/children/1",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "types", "children", "1"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 2b:** Get children ticket types for a specific parent.\n\nReplace `1` in the URL with the actual `parent_id` from Step 2.\n\nReturns the parent info and all its children."
          },
          "response": []
        },
        {
          "name": "3. Get Children Types",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/types/children",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "types", "children"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 3:** Get all child ticket types with parent information.\n\nEach child includes `parent_id` and `parent_name`."
          },
          "response": []
        },
        {
          "name": "4. Get All Types (Tree)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/types",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "types"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 4:** Get all types in both flat list and tree structure.\n\nReturns `types` (flat) and `type_tree` (grouped by parent)."
          },
          "response": []
        },
        {
          "name": "5. Create Ticket (with images)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (pm.response.code === 200 || pm.response.code === 201) {",
                  "  var json = pm.response.json();",
                  "  if (json.ticket) {",
                  "    var ticketId = json.ticket.id || json.ticket.data?.id;",
                  "    var ticketNumber = json.ticket.ticket_number || json.ticket.data?.ticket_number;",
                  "    if (ticketId) {",
                  "      pm.collectionVariables.set('ticket_id', ticketId);",
                  "      pm.environment.set('ticket_id', ticketId);",
                  "      console.log('Ticket ID saved:', ticketId);",
                  "    }",
                  "    if (ticketNumber) {",
                  "      pm.collectionVariables.set('ticket_number', ticketNumber);",
                  "      pm.environment.set('ticket_number', ticketNumber);",
                  "      console.log('Ticket Number saved:', ticketNumber);",
                  "    }",
                  "  }",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                { "key": "support_ticket_type_id", "value": "2", "description": "Use ID from parent or child types", "type": "text" },
                { "key": "branch_location_id", "value": "1", "description": "Valid branch location ID", "type": "text" },
                { "key": "problem", "value": "The app crashes when I try to checkout. This is a test ticket.", "type": "text" },
                { "key": "contact_email", "value": "customer@example.com", "type": "text" },
                { "key": "contact_phone", "value": "+201234567890", "type": "text" },
                { "key": "callback_requested", "value": "false", "type": "text" },
                { "key": "callback_time", "value": "", "description": "Required if callback_requested=true", "type": "text", "disabled": true },
                { "key": "callback_notes", "value": "", "type": "text", "disabled": true },
                { "key": "images[]", "type": "file", "description": "Optional: Upload 1-3 images (max 5MB each)", "src": [] }
              ]
            },
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 5:** Create a new support ticket.\n\n**Required:**\n- `support_ticket_type_id`: Use ID from step 2 or 3\n- `branch_location_id`: Valid branch ID\n- `problem`: Description (min 5 chars)\n- `contact_email`: Valid email\n- `contact_phone`: Phone number\n\n**Optional:**\n- `images[]`: Upload images (jpeg, jpg, png, gif, webp, max 5MB each)\n- `callback_requested`: true/false\n- `callback_time`: Required if callback_requested=true\n- `callback_notes`: Additional notes\n\n**Auto-saves:** `ticket_id` and `ticket_number` to variables."
          },
          "response": []
        },
        {
          "name": "6. List My Tickets",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 6:** List all tickets for the authenticated user.\n\nReturns paginated list with ticket details."
          },
          "response": []
        },
        {
          "name": "7. Get Ticket Details (by id)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/{{ticket_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "{{ticket_id}}"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 7:** Get full ticket details including all messages.\n\nUses `ticket_id` variable (auto-saved from step 5)."
          },
          "response": []
        },
        {
          "name": "8. List Ticket Messages",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/{{ticket_id}}/messages",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "{{ticket_id}}", "messages"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 8:** Get all messages in the ticket thread.\n\nShows the complete conversation history."
          },
          "response": []
        },
        {
          "name": "9. Send Message (Customer Reply)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                { "key": "message", "value": "Thank you for the update. I'll try that solution.", "type": "text" },
                { "key": "images[]", "type": "file", "description": "Optional: Attach images to your message", "src": [] }
              ]
            },
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/{{ticket_id}}/messages",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "{{ticket_id}}", "messages"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 9:** Send a message in the ticket thread.\n\n**Required:**\n- `message`: Your message text (min 1, max 5000 chars)\n\n**Optional:**\n- `images[]`: Attach images to your message\n\n**Note:** After admin replies in dashboard, run step 8 again to see the reply."
          },
          "response": []
        },
        {
          "name": "10. Get Ticket Status (by ticket_number)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" },
              { "key": "Content-Type", "value": "application/json", "type": "text" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"ticket_number\": \"{{ticket_number}}\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{base_url}}/api/v1/customer/support-tickets/status",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "support-tickets", "status"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "**Step 10:** Check ticket status using ticket number.\n\nUses `ticket_number` variable (auto-saved from step 5).\n\n**Status values:** open, in_progress, resolved, closed"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Missions",
      "item": [
        {
          "name": "Get Missions",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" },
              { "key": "Content-Type", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/missions",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "missions"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            }
          },
          "response": []
        },
        {
          "name": "Submit Mission",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                { "key": "note", "value": "Completed the mission, please review.", "type": "text" },
                { "key": "proof_image", "type": "file", "src": "" }
              ]
            },
            "url": {
              "raw": "{{base_url}}/api/v1/customer/missions/{{mission_id}}/submit",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "missions", "{{mission_id}}", "submit"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            },
            "description": "If the mission requires proof, attach an image file in `proof_image`."
          },
          "response": []
        },
        {
          "name": "My Mission Submissions",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Accept", "value": "application/json", "type": "text" },
              { "key": "Content-Type", "value": "application/json", "type": "text" }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/customer/missions/my-submissions",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "customer", "missions", "my-submissions"]
            },
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{auth_token}}", "type": "string" }]
            }
          },
          "response": []
        }
      ]
    }
  ]
}
